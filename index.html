<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸æ“šå„€è¡¨æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .controls {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #404040;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .controls {
                padding: 20px;
                margin-bottom: 30px;
                gap: 15px;
                justify-content: flex-end;
            }
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 0 5px;
        }
        .nav-tab {
            padding: 10px 15px;
            background: #404040;
            color: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s;
            flex: 1;
            min-width: 0;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .nav-tabs {
                gap: 15px;
                margin-bottom: 20px;
                padding: 0;
            }
            .nav-tab {
                padding: 12px 25px;
                font-size: 14px;
                flex: none;
            }
        }
        .nav-tab.active { background: #64B5F6; color: #1a1a1a; }
        .nav-tab:hover { background: #555; }
        
        .sync-info {
            font-size: 12px;
            color: #b0b0b0;
            display: flex;
            flex-direction: column;
            gap: 3px;
            text-align: center;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            .sync-info {
                font-size: 13px;
                gap: 5px;
                text-align: left;
                width: auto;
            }
        }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }
        }
        
        .card {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #404040;
            transition: transform 0.2s;
        }
        
        @media (min-width: 768px) {
            .card {
                padding: 25px;
            }
        }
        
        .card:hover {
            transform: translateY(-3px);
            border-color: #64B5F6;
        }
        
        .comparison-card {
            background: #424242;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
            border: 1px solid #555;
        }
        
        @media (min-width: 768px) {
            .comparison-card {
                padding: 20px;
            }
        }
        
        .comparison-card:hover {
            transform: translateY(-3px);
            background: #505050;
            border-color: #64B5F6;
        }
        .comparison-card h4 { 
            margin: 0 0 12px 0; 
            font-size: 1.1rem; 
        }
        
        @media (min-width: 768px) {
            .comparison-card h4 { 
                margin: 0 0 15px 0; 
                font-size: 1.2rem; 
            }
        }
        
        .member-value {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 1rem;
        }
        
        @media (min-width: 768px) {
            .member-value {
                margin: 8px 0;
                font-size: 1.1rem;
            }
        }
        .difference-row {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 12px;
            margin-top: 12px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
                gap: 30px;
            }
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        .chart-canvas { 
            position: relative; 
            height: 300px; 
        }
        
        @media (min-width: 768px) {
            .chart-title {
                font-size: 1.4rem;
                margin-bottom: 20px;
            }
            .chart-canvas { 
                height: 400px; 
            }
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status.success { background: #1B5E20; color: #C8E6C9; }
        .status.error { background: #B71C1C; color: #FFCDD2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="sync-info">
                <span id="syncStatus">æœªé€£æ¥</span>
                <span id="lastSync"></span>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('comparison')">ğŸ“Š æœ€æ–°æ•¸æ“šæ¯”è¼ƒ</button>
            <button class="nav-tab" onclick="showPage('trends')">ğŸ“ˆ è¶¨å‹¢åˆ†æ</button>
            <button class="nav-tab" onclick="showPage('differences')">ğŸ“Š å·®å€¼åˆ†æ</button>
        </div>

        <div id="status" class="status" style="display:none;"></div>

        <!-- é é¢1: æœ€æ–°æ•¸æ“šæ¯”è¼ƒ -->
        <div id="comparison" class="page active">
            <div class="card">
                <h2>ğŸ“ˆ æœ€æ–°æ•¸æ“šè©³ç´°æ¯”è¼ƒ</h2>
                <div class="comparison-grid" id="comparisonGrid"></div>
            </div>
        </div>

        <!-- é é¢2: è¶¨å‹¢åˆ†æ -->
        <div id="trends" class="page">
            <div class="charts-grid">
                <div class="card">
                    <div class="chart-title">ğŸ’– ç¸½äººæ°£å€¼è¶¨å‹¢</div>
                    <div class="chart-canvas"><canvas id="totalPopularityChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="chart-title">ğŸ¤ ç¸½åŠ©åŠ›äººæ•¸è¶¨å‹¢</div>
                    <div class="chart-canvas"><canvas id="totalSupportChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="chart-title">ğŸ”¥ ä»Šæ—¥äººæ°£å€¼è¶¨å‹¢</div>
                    <div class="chart-canvas"><canvas id="todayPopularityChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="chart-title">ğŸ’¥ ä»Šæ—¥åƒèˆ‡äººæ•¸è¶¨å‹¢</div>
                    <div class="chart-canvas"><canvas id="todayParticipantsChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- é é¢3: å·®å€¼åˆ†æ -->
        <div id="differences" class="page">
            <div class="charts-grid">
                <div class="card">
                    <div class="chart-title">ğŸ’– ç¸½äººæ°£å€¼å·®å€¼</div>
                    <div class="chart-canvas"><canvas id="totalPopularityDiffChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="chart-title">ğŸ¤ ç¸½åŠ©åŠ›äººæ•¸å·®å€¼</div>
                    <div class="chart-canvas"><canvas id="totalSupportDiffChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="chart-title">ğŸ”¥ ä»Šæ—¥äººæ°£å€¼å·®å€¼</div>
                    <div class="chart-canvas"><canvas id="todayPopularityDiffChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="chart-title">ğŸ’¥ ä»Šæ—¥åƒèˆ‡äººæ•¸å·®å€¼</div>
                    <div class="chart-canvas"><canvas id="todayParticipantsDiffChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalData = [];
        let charts = {};
        let currentPage = 'comparison';
        let autoSyncInterval = null;
        let sheetsUrl = 'https://docs.google.com/spreadsheets/d/1OwdPmIuge1Bw8p6laA8QdPcFzKrWwezJQGAi2uBlR1Y/export?format=csv&gid=1642175178';
        let lastSyncTime = null;

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            setTimeout(() => statusDiv.style.display = 'none', 3000);
        }

        function updateSyncStatus(status, message = '') {
            document.getElementById('syncStatus').textContent = status;
            if (lastSyncTime) {
                document.getElementById('lastSync').textContent = `ä¸Šæ¬¡åŒæ­¥: ${lastSyncTime.toLocaleString('zh-TW')}`;
            }
            if (message) showStatus(message, status.includes('éŒ¯èª¤') ? 'error' : 'success');
        }

        function parseNumber(value) {
            if (typeof value === 'number') return value;
            return parseInt(String(value).replace(/,/g, '')) || 0;
        }

        function parseDateTime(dateTimeStr) {
            if (!dateTimeStr) return new Date();
            let cleanedStr = dateTimeStr.replace(/ä¸Šåˆ|ä¸‹åˆ/g, '').trim();
            if (dateTimeStr.includes('ä¸‹åˆ')) {
                const parts = cleanedStr.split(' ');
                if (parts.length >= 2) {
                    const timeComponents = parts[1].split(':');
                    let hour = parseInt(timeComponents[0]);
                    if (hour !== 12) hour += 12;
                    timeComponents[0] = hour.toString();
                    parts[1] = timeComponents.join(':');
                    cleanedStr = parts.join(' ');
                }
            }
            try {
                return new Date(cleanedStr);
            } catch {
                return new Date();
            }
        }

        async function syncFromGoogleSheets() {
            updateSyncStatus('ğŸ”„ åŒæ­¥ä¸­...');
            try {
                const response = await fetch(sheetsUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                
                if (!csvText || csvText.includes('<html')) {
                    throw new Error('ç²å–çš„ä¸æ˜¯CSVè³‡æ–™ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œ');
                }

                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const newData = results.data.filter(row => 
                            row.æˆå“¡ && (row.æˆå“¡ === 'Felix' || row.æˆå“¡ === 'Hyunjin')
                        );
                        
                        if (newData.length === 0) {
                            updateSyncStatus('âŒ é€£æ¥éŒ¯èª¤', 'æœªæ‰¾åˆ°Felixæˆ–Hyunjinçš„è³‡æ–™');
                            return;
                        }

                        newData.sort((a, b) => parseDateTime(a.åŸ·è¡Œæ™‚é–“) - parseDateTime(b.åŸ·è¡Œæ™‚é–“));
                        globalData = newData;
                        lastSyncTime = new Date();
                        
                        createDashboard();
                        updateSyncStatus('âœ… åŒæ­¥å®Œæˆ', `æˆåŠŸåŒæ­¥ ${globalData.length} ç­†è³‡æ–™`);
                    },
                    error: function(error) {
                        updateSyncStatus('âŒ é€£æ¥éŒ¯èª¤', 'CSVè§£æéŒ¯èª¤: ' + error.message);
                    }
                });
            } catch (error) {
                updateSyncStatus('âŒ é€£æ¥éŒ¯èª¤', error.message);
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            currentPage = pageId;
            
            if (globalData.length > 0 && (pageId === 'trends' || pageId === 'differences')) {
                setTimeout(createCharts, 100);
            }
        }

        function createDashboard() {
            createComparisonCards();
            if (currentPage === 'trends' || currentPage === 'differences') {
                createCharts();
            }
        }

        function createComparisonCards() {
            const latestData = {};
            globalData.forEach(row => {
                if (!latestData[row.æˆå“¡] || parseDateTime(row.åŸ·è¡Œæ™‚é–“) > parseDateTime(latestData[row.æˆå“¡].åŸ·è¡Œæ™‚é–“)) {
                    latestData[row.æˆå“¡] = row;
                }
            });

            const metrics = [
                { key: 'ç¸½äººæ°£å€¼', icon: 'ğŸ’–' },
                { key: 'ç¸½åŠ©åŠ›äººæ•¸', icon: 'ğŸ¤' },
                { key: 'ä»Šæ—¥äººæ°£å€¼', icon: 'ğŸ”¥' },
                { key: 'ä»Šæ—¥åƒèˆ‡äººæ•¸', icon: 'ğŸ’¥' }
            ];

            document.getElementById('comparisonGrid').innerHTML = metrics.map(metric => {
                const felixValue = latestData.Felix ? parseNumber(latestData.Felix[metric.key]) : 0;
                const hyunjinValue = latestData.Hyunjin ? parseNumber(latestData.Hyunjin[metric.key]) : 0;
                const difference = felixValue - hyunjinValue;
                const differenceText = difference >= 0 ? `+${difference.toLocaleString()}` : difference.toLocaleString();
                
                return `
                    <div class="comparison-card">
                        <h4>${metric.icon} ${metric.key}</h4>
                        <div class="member-value">
                            <span>Felix:</span>
                            <span>${felixValue.toLocaleString()}</span>
                        </div>
                        <div class="member-value">
                            <span>Hyunjin:</span>
                            <span>${hyunjinValue.toLocaleString()}</span>
                        </div>
                        <div class="member-value difference-row">
                            <span>å·®å€¼:</span>
                            <span style="color: ${difference >= 0 ? '#90EE90' : '#FFB6C1'}">${differenceText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function createCharts() {
            const timePoints = [...new Set(globalData.map(row => row.åŸ·è¡Œæ™‚é–“))].sort((a, b) => parseDateTime(a) - parseDateTime(b));
            
            Object.values(charts).forEach(chart => chart && chart.destroy());
            charts = {};

            const metrics = [
                { key: 'ç¸½äººæ°£å€¼', id: 'totalPopularityChart' },
                { key: 'ç¸½åŠ©åŠ›äººæ•¸', id: 'totalSupportChart' },
                { key: 'ä»Šæ—¥äººæ°£å€¼', id: 'todayPopularityChart' },
                { key: 'ä»Šæ—¥åƒèˆ‡äººæ•¸', id: 'todayParticipantsChart' }
            ];

            metrics.forEach(metric => {
                if (currentPage === 'trends') {
                    charts[metric.id] = createTrendChart(metric.id, timePoints, metric.key);
                } else if (currentPage === 'differences') {
                    charts[metric.id.replace('Chart', 'DiffChart')] = createDifferenceChart(metric.id.replace('Chart', 'DiffChart'), timePoints, metric.key);
                }
            });
        }

        function createTrendChart(canvasId, timePoints, dataKey) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            const ctx = canvas.getContext('2d');
            const felixData = timePoints.map(time => {
                const row = globalData.find(r => r.åŸ·è¡Œæ™‚é–“ === time && r.æˆå“¡ === 'Felix');
                return row ? parseNumber(row[dataKey]) : null;
            });
            const hyunjinData = timePoints.map(time => {
                const row = globalData.find(r => r.åŸ·è¡Œæ™‚é–“ === time && r.æˆå“¡ === 'Hyunjin');
                return row ? parseNumber(row[dataKey]) : null;
            });

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints.map(time => parseDateTime(time).toLocaleDateString('zh-TW', { 
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                    })),
                    datasets: [{
                        label: 'Felix',
                        data: felixData,
                        borderColor: '#64B5F6',
                        backgroundColor: 'rgba(100, 181, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        spanGaps: true
                    }, {
                        label: 'Hyunjin',
                        data: hyunjinData,
                        borderColor: '#FFB74D',
                        backgroundColor: 'rgba(255, 183, 77, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: { 
                            beginAtZero: false,
                            ticks: { 
                                color: '#b0b0b0', 
                                callback: value => value.toLocaleString(),
                                font: { size: window.innerWidth < 768 ? 10 : 12 }
                            },
                            grid: { color: '#404040' }
                        },
                        x: { 
                            ticks: { 
                                color: '#b0b0b0', 
                                maxRotation: window.innerWidth < 768 ? 90 : 45,
                                font: { size: window.innerWidth < 768 ? 10 : 12 }
                            },
                            grid: { color: '#404040' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        tooltip: {
                            backgroundColor: '#2d2d2d',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#64B5F6',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        function createDifferenceChart(canvasId, timePoints, dataKey) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            const ctx = canvas.getContext('2d');
            const differences = timePoints.map(time => {
                const felixRow = globalData.find(r => r.åŸ·è¡Œæ™‚é–“ === time && r.æˆå“¡ === 'Felix');
                const hyunjinRow = globalData.find(r => r.åŸ·è¡Œæ™‚é–“ === time && r.æˆå“¡ === 'Hyunjin');
                
                if (!felixRow || !hyunjinRow) return null;
                return parseNumber(felixRow[dataKey]) - parseNumber(hyunjinRow[dataKey]);
            });

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints.map(time => parseDateTime(time).toLocaleDateString('zh-TW', { 
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                    })),
                    datasets: [{
                        label: `${dataKey}å·®å€¼ (Felix - Hyunjin)`,
                        data: differences,
                        borderColor: '#64B5F6',
                        backgroundColor: function(context) {
                            const value = context.parsed?.y;
                            return value >= 0 ? 'rgba(100, 181, 246, 0.2)' : 'rgba(244, 67, 54, 0.2)';
                        },
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: { 
                            ticks: { 
                                color: '#b0b0b0', 
                                callback: value => value >= 0 ? `+${value.toLocaleString()}` : value.toLocaleString(),
                                font: { size: window.innerWidth < 768 ? 10 : 12 }
                            },
                            grid: { color: context => context.tick.value === 0 ? '#64B5F6' : '#404040' }
                        },
                        x: { 
                            ticks: { 
                                color: '#b0b0b0', 
                                maxRotation: window.innerWidth < 768 ? 90 : 45,
                                font: { size: window.innerWidth < 768 ? 10 : 12 }
                            },
                            grid: { color: '#404040' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        tooltip: {
                            backgroundColor: '#2d2d2d',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#64B5F6',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ– - è‡ªå‹•é–‹å§‹åŒæ­¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                syncFromGoogleSheets();
                // è¨­ç½®è‡ªå‹•åŒæ­¥ï¼Œæ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡
                autoSyncInterval = setInterval(syncFromGoogleSheets, 60000);
                updateSyncStatus('ğŸŸ¢ å·²é€£æ¥ - è‡ªå‹•åŒæ­¥ä¸­');
            }, 1000);
        });
        
        window.addEventListener('beforeunload', () => autoSyncInterval && clearInterval(autoSyncInterval));
    </script>
</body>
</html>
