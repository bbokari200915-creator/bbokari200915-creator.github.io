<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube數據儀表板</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .controls {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #404040;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        
        @media (min-width: 768px) {
            .controls {
                padding: 20px;
                margin-bottom: 30px;
                gap: 15px;
            }
        }
        
        .date-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .date-button {
            padding: 8px 15px;
            background: #404040;
            color: #e0e0e0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .date-button.active {
            background: #64B5F6;
            color: #1a1a1a;
        }
        
        .date-button:hover:not(.active) {
            background: #555;
        }
        
        @media (min-width: 768px) {
            .date-button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        .sync-info {
            font-size: 12px;
            color: #b0b0b0;
            display: flex;
            flex-direction: column;
            gap: 3px;
            text-align: center;
            width: 100%;
        }
        
        .sync-status-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }
        
        .sync-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }
        
        @media (min-width: 768px) {
            .sync-info {
                font-size: 13px;
                gap: 5px;
                text-align: left;
                width: auto;
            }
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
                gap: 30px;
            }
        }
        
        .card {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #404040;
            transition: transform 0.2s;
        }
        
        @media (min-width: 768px) {
            .card {
                padding: 25px;
            }
        }
        
        .card:hover {
            transform: translateY(-3px);
            border-color: #64B5F6;
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-controls label {
            font-size: 12px;
            color: #b0b0b0;
        }

        .chart-controls input[type="date"] {
            background: #404040;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
        }

        .chart-controls input[type="date"]:focus {
            outline: none;
            border-color: #64B5F6;
        }

        @media (min-width: 768px) {
            .chart-controls label {
                font-size: 14px;
            }
            .chart-controls input[type="date"] {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        .chart-canvas { 
            position: relative; 
            height: 300px; 
        }
        
        @media (min-width: 768px) {
            .chart-title {
                font-size: 1.4rem;
                margin-bottom: 20px;
            }
            .chart-canvas { 
                height: 400px; 
            }
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status.success { background: #1B5E20; color: #C8E6C9; }
        .status.error { background: #B71C1C; color: #FFCDD2; }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { 
            background: #4CAF50; 
            color: white; 
        }
        .toast.error { 
            background: #f44336; 
            color: white; 
        }
        
        @media (max-width: 768px) {
            .toast {
                top: auto;
                bottom: 20px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(100%);
            }
            .toast.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div class="date-selector">
                <span style="color: #e0e0e0; font-weight: bold;">選擇直播:</span>
                <button class="date-button active" onclick="selectDate('音銀 1')" data-date="音銀 1">音銀 1</button>
                <button class="date-button" onclick="selectDate('音銀 2')" data-date="音銀 2">音銀 2</button>
                <button class="date-button" onclick="selectDate('直播3')" data-date="直播3">直播3</button>
            </div>
            
            <div class="sync-info">
                <div class="sync-status-row">
                    <span id="syncStatus">未連接</span>
                    <div class="sync-right">
                        <span id="lastSync"></span>
                        <span id="latestData"></span>
                        <span style="color: #888; font-size: 11px;">📡 數據每5分鐘更新</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="status" class="status" style="display:none;"></div>

        <!-- YouTube數據圖表 -->
        <div class="charts-grid">
            <div class="card">
                <div class="chart-title">👀 觀看次數</div>
                <div class="chart-controls">
                    <label>From:</label>
                    <input type="date" id="viewFromDate" onchange="updateChart('viewCountChart')">
                    <label>To:</label>
                    <input type="date" id="viewToDate" onchange="updateChart('viewCountChart')">
                </div>
                <div class="chart-canvas"><canvas id="viewCountChart"></canvas></div>
            </div>
            <div class="card">
                <div class="chart-title">👍 點贊數</div>
                <div class="chart-controls">
                    <label>From:</label>
                    <input type="date" id="likeFromDate" onchange="updateChart('likeCountChart')">
                    <label>To:</label>
                    <input type="date" id="likeToDate" onchange="updateChart('likeCountChart')">
                </div>
                <div class="chart-canvas"><canvas id="likeCountChart"></canvas></div>
            </div>
            <div class="card">
                <div class="chart-title">💬 評論數</div>
                <div class="chart-controls">
                    <label>From:</label>
                    <input type="date" id="commentFromDate" onchange="updateChart('commentCountChart')">
                    <label>To:</label>
                    <input type="date" id="commentToDate" onchange="updateChart('commentCountChart')">
                </div>
                <div class="chart-canvas"><canvas id="commentCountChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        let globalData = [];
        let charts = {};
        let currentSource = '音銀 1'; // 默認數據源
        let autoSyncInterval = null;
        let lastSyncTime = null;

        // 不同數據源對應的 Google Sheets URL
        const sheetsUrls = {
            '音銀 1': 'https://docs.google.com/spreadsheets/d/1lnFHt_4oFxxvjQk-Lnn3B6OoxQK4SV0fMi0Z466QoRg/export?format=csv&gid=714013901',
            '音銀 2': 'https://docs.google.com/spreadsheets/d/1lnFHt_4oFxxvjQk-Lnn3B6OoxQK4SV0fMi0Z466QoRg/export?format=csv&gid=1229040293',
            '直播3': ''  // 需要時添加 URL
        };

        function selectDate(source) {
            // 更新按鈕狀態
            document.querySelectorAll('.date-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-date="${source}"]`).classList.add('active');
            
            currentSource = source;
            syncFromGoogleSheets();
        }

        function showStatus(message, type = 'success') {
            // 移除現有的toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // 創建新的toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 顯示toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // 3秒後隱藏並移除toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateSyncStatus(status, message = '') {
            document.getElementById('syncStatus').textContent = status;
            if (lastSyncTime) {
                document.getElementById('lastSync').textContent = `上次同步: ${lastSyncTime.toLocaleString('zh-CN')}`;
            }
            
            // 更新最新數據時間
            if (globalData.length > 0) {
                const latestTime = Math.max(...globalData.map(row => parseDateTime(row.更新時間)));
                const latestDate = new Date(latestTime);
                document.getElementById('latestData').textContent = `最新數據: ${latestDate.toLocaleString('zh-CN')}`;
            }
            
            if (message) showStatus(message, status.includes('錯誤') ? 'error' : 'success');
        }

        function parseNumber(value) {
            if (typeof value === 'number') return value;
            return parseInt(String(value).replace(/,/g, '')) || 0;
        }

        function parseDateTime(dateTimeStr) {
            if (!dateTimeStr) return new Date();
            try {
                return new Date(dateTimeStr);
            } catch {
                return new Date();
            }
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function initializeDateInputs() {
            if (globalData.length === 0) return;
            
            const dates = globalData.map(row => parseDateTime(row.更新時間)).sort((a, b) => a - b);
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            const dateInputs = [
                'viewFromDate', 'viewToDate',
                'likeFromDate', 'likeToDate', 
                'commentFromDate', 'commentToDate'
            ];
            
            dateInputs.forEach((inputId, index) => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.min = formatDateForInput(minDate);
                    input.max = formatDateForInput(maxDate);
                    
                    // 設置默認值：From為最小日期，To為最大日期
                    if (inputId.includes('From')) {
                        input.value = formatDateForInput(minDate);
                    } else {
                        input.value = formatDateForInput(maxDate);
                    }
                }
            });
        }

        function getFilteredData(chartId) {
            if (globalData.length === 0) return { timePoints: [], filteredData: [] };
            
            let fromDateId, toDateId;
            if (chartId === 'viewCountChart') {
                fromDateId = 'viewFromDate';
                toDateId = 'viewToDate';
            } else if (chartId === 'likeCountChart') {
                fromDateId = 'likeFromDate';
                toDateId = 'likeToDate';
            } else if (chartId === 'commentCountChart') {
                fromDateId = 'commentFromDate';
                toDateId = 'commentToDate';
            }
            
            const fromDate = new Date(document.getElementById(fromDateId).value);
            const toDate = new Date(document.getElementById(toDateId).value + 'T23:59:59');
            
            const filteredData = globalData.filter(row => {
                const rowDate = parseDateTime(row.更新時間);
                return rowDate >= fromDate && rowDate <= toDate;
            });
            
            const timePoints = [...new Set(filteredData.map(row => row.更新時間))].sort((a, b) => parseDateTime(a) - parseDateTime(b));
            
            return { timePoints, filteredData };
        }

        function updateChart(chartId) {
            if (!charts[chartId] || globalData.length === 0) return;
            
            const { timePoints, filteredData } = getFilteredData(chartId);
            
            if (timePoints.length === 0) {
                return;
            }
            
            const members = [...new Set(globalData.map(row => row.成員))];
            const memberColors = {
                [members[0]]: '#64B5F6',
                [members[1]]: '#FFB74D',
                [members[2]]: '#81C784',
                [members[3]]: '#F06292',
                [members[4]]: '#9575CD'
            };
            
            let dataKey;
            if (chartId === 'viewCountChart') dataKey = '觀看次數';
            else if (chartId === 'likeCountChart') dataKey = '點贊數';
            else if (chartId === 'commentCountChart') dataKey = '評論數';
            
            const datasets = members.map(member => {
                const memberData = timePoints.map(time => {
                    const row = filteredData.find(r => r.更新時間 === time && r.成員 === member);
                    return row ? parseNumber(row[dataKey]) : null;
                });

                return {
                    label: member,
                    data: memberData,
                    borderColor: memberColors[member] || '#64B5F6',
                    backgroundColor: (memberColors[member] || '#64B5F6') + '20',
                    borderWidth: window.innerWidth < 768 ? 2 : 3,
                    pointRadius: window.innerWidth < 768 ? 1.5 : 2,
                    pointHoverRadius: window.innerWidth < 768 ? 3 : 4,
                    tension: 0.4,
                    spanGaps: true,
                    fill: false
                };
            });
            
            charts[chartId].data.labels = timePoints.map(time => parseDateTime(time).toLocaleString('zh-CN', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            }));
            charts[chartId].data.datasets = datasets;
            charts[chartId].update();
        }

        async function syncFromGoogleSheets() {
            const sheetsUrl = sheetsUrls[currentSource];
            if (!sheetsUrl) {
                updateSyncStatus('⚠ 待配置', `${currentSource} 的URL尚未配置`);
                return;
            }

            updateSyncStatus('🔄 同步中...');
            try {
                const response = await fetch(sheetsUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                
                if (!csvText || csvText.includes('<html')) {
                    throw new Error('獲取的不是CSV資料，可能是權限問題');
                }

                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const newData = results.data.filter(row => 
                            row.成員 && row.視頻ID && row.更新時間
                        );
                        
                        if (newData.length === 0) {
                            updateSyncStatus('⚠ 數據為空', '未找到有效的YouTube數據');
                            return;
                        }

                        newData.sort((a, b) => parseDateTime(a.更新時間) - parseDateTime(b.更新時間));
                        
                        // 檢查數據是否有變動
                        const hasDataChanged = globalData.length !== newData.length || 
                            JSON.stringify(globalData) !== JSON.stringify(newData);
                        
                        if (hasDataChanged) {
                            globalData = newData;
                            initializeDateInputs();
                            createCharts();
                            updateSyncStatus('✅ 同步完成', `${currentSource} 數據已更新 - ${globalData.length} 筆資料`);
                        } else {
                            updateSyncStatus('✅ 同步完成', `${currentSource} 數據無變化`);
                        }
                        
                        lastSyncTime = new Date();
                    },
                    error: function(error) {
                        updateSyncStatus('⚠ 連接錯誤', 'CSV解析錯誤: ' + error.message);
                    }
                });
            } catch (error) {
                updateSyncStatus('⚠ 連接錯誤', error.message);
            }
        }

        function createCharts() {
            if (globalData.length === 0) return;

            // 銷毀現有圖表
            Object.values(charts).forEach(chart => chart && chart.destroy());
            charts = {};

            // 獲取所有成員
            const members = [...new Set(globalData.map(row => row.成員))];
            
            // 獲取所有時間點
            const timePoints = [...new Set(globalData.map(row => row.更新時間))].sort((a, b) => parseDateTime(a) - parseDateTime(b));

            // 生成成員顏色
            const memberColors = {
                [members[0]]: '#64B5F6',
                [members[1]]: '#FFB74D',
                [members[2]]: '#81C784',
                [members[3]]: '#F06292',
                [members[4]]: '#9575CD'
            };

            // 創建三個圖表
            const metrics = [
                { key: '觀看次數', id: 'viewCountChart' },
                { key: '點贊數', id: 'likeCountChart' },
                { key: '評論數', id: 'commentCountChart' }
            ];

            metrics.forEach(metric => {
                charts[metric.id] = createTrendChart(metric.id, timePoints, metric.key, members, memberColors);
            });
        }

        function createTrendChart(canvasId, timePoints, dataKey, members, memberColors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;
            
            const ctx = canvas.getContext('2d');
            
            // 為每個成員創建數據集
            const datasets = members.map(member => {
                const memberData = timePoints.map(time => {
                    const row = globalData.find(r => r.更新時間 === time && r.成員 === member);
                    return row ? parseNumber(row[dataKey]) : null;
                });

                return {
                    label: member,
                    data: memberData,
                    borderColor: memberColors[member] || '#64B5F6',
                    backgroundColor: (memberColors[member] || '#64B5F6') + '20',
                    borderWidth: window.innerWidth < 768 ? 2 : 3,
                    pointRadius: window.innerWidth < 768 ? 1.5 : 2,
                    pointHoverRadius: window.innerWidth < 768 ? 3 : 4,
                    tension: 0.4,
                    spanGaps: true,
                    fill: false
                };
            });

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timePoints.map(time => parseDateTime(time).toLocaleString('zh-CN', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: { 
                            beginAtZero: false,
                            ticks: { 
                                color: '#b0b0b0', 
                                callback: value => value.toLocaleString(),
                                font: { size: window.innerWidth < 768 ? 10 : 12 }
                            },
                            grid: { color: '#404040' }
                        },
                        x: { 
                            ticks: { 
                                color: '#b0b0b0', 
                                maxRotation: window.innerWidth < 768 ? 90 : 45,
                                font: { size: window.innerWidth < 768 ? 10 : 12 }
                            },
                            grid: { color: '#404040' }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'top', 
                            labels: { 
                                color: '#e0e0e0',
                                usePointStyle: true,
                                padding: 20
                            } 
                        },
                        tooltip: {
                            backgroundColor: '#2d2d2d',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#64B5F6',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 初始化 - 自動開始同步
        window.addEventListener('load', () => {
            setTimeout(() => {
                syncFromGoogleSheets();
                // 設置自動同步，每分鐘更新一次
                autoSyncInterval = setInterval(syncFromGoogleSheets, 60000);
                updateSyncStatus('🟢 已連接 - 自動同步中');
            }, 1000);
        });
        
        window.addEventListener('beforeunload', () => autoSyncInterval && clearInterval(autoSyncInterval));
    </script>
</body>
</html>
