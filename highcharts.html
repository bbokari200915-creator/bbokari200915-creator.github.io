<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTubeÊï∞ÊçÆ‰ª™Ë°®Êùø</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/highcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .controls {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #404040;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        @media (min-width: 768px) {
            .controls {
                padding: 20px;
                margin-bottom: 30px;
                gap: 15px;
            }
        }

        .date-selector,
        .time-range-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .control-group {
                flex-direction: row;
                width: auto;
                gap: 20px;
            }
        }

        .date-button,
        .time-button {
            padding: 8px 15px;
            background: #404040;
            color: #e0e0e0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .date-button.active,
        .time-button.active {
            background: #64B5F6;
            color: #1a1a1a;
        }

        .date-button:hover:not(.active),
        .time-button:hover:not(.active) {
            background: #555;
        }

        .time-button {
            background: #2d5a2d;
        }

        .time-button.active {
            background: #81C784;
            color: #1a1a1a;
        }

        .time-button:hover:not(.active) {
            background: #3d6a3d;
        }

        @media (min-width: 768px) {

            .date-button,
            .time-button {
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        .sync-info {
            font-size: 12px;
            color: #b0b0b0;
            display: flex;
            flex-direction: column;
            gap: 3px;
            text-align: center;
            width: 100%;
        }

        .sync-status-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        .sync-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        @media (min-width: 768px) {
            .sync-info {
                font-size: 13px;
                gap: 5px;
                text-align: left;
                width: auto;
            }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
                gap: 30px;
            }
        }

        .card {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #404040;
            transition: transform 0.2s;
        }

        @media (min-width: 768px) {
            .card {
                padding: 25px;
            }
        }

        .card:hover {
            transform: translateY(-3px);
            border-color: #64B5F6;
        }

        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .chart-container {
            height: 300px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .chart-title {
                font-size: 1.4rem;
                margin-bottom: 20px;
            }

            .chart-container {
                height: 400px;
            }
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
        }

        .status.success {
            background: #1B5E20;
            color: #C8E6C9;
        }

        .status.error {
            background: #B71C1C;
            color: #FFCDD2;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #4CAF50;
            color: white;
        }

        .toast.error {
            background: #f44336;
            color: white;
        }

        @media (max-width: 768px) {
            .toast {
                top: auto;
                bottom: 20px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(100%);
            }

            .toast.show {
                transform: translateY(0);
            }
        }

        /* Highcharts Ê∑±Ëâ≤‰∏ªÈ¢òÊ†∑Âºè */
        .highcharts-background {
            fill: #2d2d2d;
        }

        .highcharts-plot-background {
            fill: #2d2d2d;
        }

        .highcharts-grid-line {
            stroke: #404040;
        }

        .highcharts-axis-line {
            stroke: #404040;
        }

        .highcharts-tick {
            stroke: #404040;
        }

        .highcharts-axis-labels text {
            fill: #b0b0b0;
        }

        .highcharts-legend-item text {
            fill: #e0e0e0 !important;
        }

        .highcharts-title {
            fill: #e0e0e0;
        }

        .highcharts-tooltip-box {
            fill: #2d2d2d;
            stroke: #64B5F6;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <div class="date-selector">
                    <span style="color: #e0e0e0; font-weight: bold;">ÈÄâÊã©Áõ¥Êãç:</span>
                    <button class="date-button active" onclick="selectDate('Èü≥Èì∂ 1')" data-date="Èü≥Èì∂ 1">Èü≥Èì∂ 1</button>
                    <button class="date-button" onclick="selectDate('Èü≥Èì∂ 2')" data-date="Èü≥Èì∂ 2">Èü≥Èì∂ 2</button>
                    <button class="date-button" onclick="selectDate('Áõ¥Êãç3')" data-date="Áõ¥Êãç3">Áõ¥Êãç3</button>
                </div>

                <div class="time-range-selector">
                    <span style="color: #e0e0e0; font-weight: bold;">ÈÄâÊã©Êó∂Èó¥:</span>
                    <button class="time-button active" onclick="selectTimeRange('all')" data-time="all">ÂÖ®ÈÉ®Êó∂Èó¥</button>
                    <button class="time-button" onclick="selectTimeRange('6h')" data-time="6h">ÊúÄËøë6Â∞èÊó∂</button>
                    <button class="time-button" onclick="selectTimeRange('12h')" data-time="12h">ÊúÄËøë12Â∞èÊó∂</button>
                </div>
            </div>

            <div class="sync-info">
                <div class="sync-status-row">
                    <span id="syncStatus">Êú™ËøûÊé•</span>
                    <div class="sync-right">
                        <span id="lastSync"></span>
                        <span id="latestData"></span>
                        <span style="color: #888; font-size: 11px;">üì° Êï∞ÊçÆÊØè5ÂàÜÈíüÊõ¥Êñ∞</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="status" class="status" style="display:none;"></div>

        <!-- YouTubeÊï∞ÊçÆÂõæË°® -->
        <div class="charts-grid">
            <div class="card">
                <div class="chart-title">üëÄ ËßÇÁúãÊï∞</div>
                <div id="viewCountChart" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="chart-title">üëç ÁÇπËµûÊï∞</div>
                <div id="likeCountChart" class="chart-container"></div>
            </div>
            <div class="card">
                <div class="chart-title">üí¨ ËØÑËÆ∫Êï∞</div>
                <div id="commentCountChart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
        let globalData = [];
        let charts = {};
        let currentSource = 'Èü≥Èì∂ 1'; // ÈªòËÆ§Êï∞ÊçÆÊ∫ê
        let currentTimeRange = 'all'; // ÈªòËÆ§Êó∂Èó¥ËåÉÂõ¥
        let autoSyncInterval = null;
        let lastSyncTime = null;

        // ‰∏çÂêåÊï∞ÊçÆÊ∫êÂØπÂ∫îÁöÑ Google Sheets URL
        const sheetsUrls = {
            'Èü≥Èì∂ 1': 'https://docs.google.com/spreadsheets/d/1lnFHt_4oFxxvjQk-Lnn3B6OoxQK4SV0fMi0Z466QoRg/export?format=csv&gid=714013901',
            'Èü≥Èì∂ 2': 'https://docs.google.com/spreadsheets/d/1lnFHt_4oFxxvjQk-Lnn3B6OoxQK4SV0fMi0Z466QoRg/export?format=csv&gid=1229040293',
            'Áõ¥Êãç3': '' // ÈúÄË¶ÅÊó∂Ê∑ªÂä† URL
        };

        // Highcharts ÂÖ®Â±ÄÈÖçÁΩÆ
        Highcharts.setOptions({
            colors: ['#64B5F6', '#FFB74D', '#81C784', '#F06292', '#9575CD', '#4DD0E1', '#AED581'],
            chart: {
                backgroundColor: '#2d2d2d',
                plotBackgroundColor: '#2d2d2d',
                plotBorderColor: '#404040',
                style: {
                    fontFamily: 'Arial, sans-serif',
                    color: '#e0e0e0'
                }
            },
            title: {
                style: {
                    color: '#e0e0e0'
                }
            },
            xAxis: {
                gridLineColor: '#404040',
                lineColor: '#404040',
                tickColor: '#404040',
                labels: {
                    style: {
                        color: '#b0b0b0'
                    }
                },
                title: {
                    style: {
                        color: '#b0b0b0'
                    }
                }
            },
            yAxis: {
                gridLineColor: '#404040',
                lineColor: '#404040',
                tickColor: '#404040',
                labels: {
                    style: {
                        color: '#b0b0b0'
                    }
                },
                title: {
                    style: {
                        color: '#b0b0b0'
                    }
                }
            },
            tooltip: {
                backgroundColor: '#2d2d2d',
                borderColor: '#64B5F6',
                style: {
                    color: '#e0e0e0'
                }
            },
            legend: {
                itemStyle: {
                    color: '#e0e0e0'
                },
                itemHoverStyle: {
                    color: '#64B5F6'
                }
            },
            plotOptions: {
                spline: {
                    marker: {
                        enabled: true,
                        radius: 3
                    },
                    lineWidth: 3,
                    states: {
                        hover: {
                            lineWidth: 4
                        }
                    }
                }
            }
        });

        function selectDate(source) {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.date-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-date="${source}"]`).classList.add('active');

            currentSource = source;
            syncFromGoogleSheets();
        }

        function selectTimeRange(range) {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.time-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-time="${range}"]`).classList.add('active');

            currentTimeRange = range;

            // Â¶ÇÊûúÂ∑≤ÊúâÊï∞ÊçÆÔºåÈáçÊñ∞ÂàõÂª∫ÂõæË°®‰ª•Â∫îÁî®Êó∂Èó¥Á≠õÈÄâ
            if (globalData.length > 0) {
                createCharts();
            }
        }

        function showStatus(message, type = 'success') {
            // ÁßªÈô§Áé∞ÊúâÁöÑtoast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // ÂàõÂª∫Êñ∞ÁöÑtoast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // ÊòæÁ§∫toast
            setTimeout(() => toast.classList.add('show'), 100);

            // 3ÁßíÂêéÈöêËóèÂπ∂ÁßªÈô§toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateSyncStatus(status, message = '') {
            document.getElementById('syncStatus').textContent = status;
            if (lastSyncTime) {
                document.getElementById('lastSync').textContent = `‰∏äÊ¨°ÂêåÊ≠•: ${lastSyncTime.toLocaleString('zh-CN')}`;
            }

            // Êõ¥Êñ∞ÊúÄÊñ∞Êï∞ÊçÆÊó∂Èó¥
            if (globalData.length > 0) {
                const latestTime = Math.max(...globalData.map(row => parseDateTime(row.Êõ¥Êñ∞Êó∂Èó¥)));
                const latestDate = new Date(latestTime);
                document.getElementById('latestData').textContent = `ÊúÄÊñ∞Êï∞ÊçÆ: ${latestDate.toLocaleString('zh-CN')}`;
            }

            if (message) showStatus(message, status.includes('ÈîôËØØ') ? 'error' : 'success');
        }

        function parseNumber(value) {
            if (typeof value === 'number') return value;
            return parseInt(String(value).replace(/,/g, '')) || 0;
        }

        function parseDateTime(dateTimeStr) {
            if (!dateTimeStr) return new Date();
            try {
                return new Date(dateTimeStr);
            } catch {
                return new Date();
            }
        }

        function filterDataByTimeRange(data) {
            if (currentTimeRange === 'all') {
                return data;
            }

            const now = new Date();
            let cutoffTime;

            switch (currentTimeRange) {
                case '6h':
                    cutoffTime = new Date(now.getTime() - 6 * 60 * 60 * 1000);
                    break;
                case '12h':
                    cutoffTime = new Date(now.getTime() - 12 * 60 * 60 * 1000);
                    break;
                default:
                    return data;
            }

            return data.filter(row => {
                const dataTime = parseDateTime(row.Êõ¥Êñ∞Êó∂Èó¥);
                return dataTime >= cutoffTime;
            });
        }

        async function syncFromGoogleSheets() {
            const sheetsUrl = sheetsUrls[currentSource];
            if (!sheetsUrl) {
                updateSyncStatus('‚ö† ÂæÖÈÖçÁΩÆ', `${currentSource} ÁöÑURLÂ∞öÊú™ÈÖçÁΩÆ`);
                return;
            }

            updateSyncStatus('üîÑ ÂêåÊ≠•‰∏≠...');
            try {
                const response = await fetch(sheetsUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();

                if (!csvText || csvText.includes('<html')) {
                    throw new Error('Ëé∑ÂèñÁöÑ‰∏çÊòØCSVËµÑÊñôÔºåÂèØËÉΩÊòØÊùÉÈôêÈóÆÈ¢ò');
                }

                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: false,
                    skipEmptyLines: true,
                    complete: function (results) {
                        const newData = results.data.filter(row =>
                            row.ÊàêÂëò && row.ËßÜÈ¢ëID && row.Êõ¥Êñ∞Êó∂Èó¥
                        );

                        if (newData.length === 0) {
                            updateSyncStatus('‚ö† Êï∞ÊçÆ‰∏∫Á©∫', 'Êú™ÊâæÂà∞ÊúâÊïàÁöÑYouTubeÊï∞ÊçÆ');
                            return;
                        }

                        newData.sort((a, b) => parseDateTime(a.Êõ¥Êñ∞Êó∂Èó¥) - parseDateTime(b.Êõ¥Êñ∞Êó∂Èó¥));

                        // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÊúâÂèòÂä®
                        const hasDataChanged = globalData.length !== newData.length ||
                            JSON.stringify(globalData) !== JSON.stringify(newData);

                        if (hasDataChanged) {
                            globalData = newData;
                            createCharts();
                            updateSyncStatus('‚úÖ ÂêåÊ≠•ÂÆåÊàê',
                                `${currentSource} Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞ - ${globalData.length} Á¨îËµÑÊñô`);
                        } else {
                            updateSyncStatus('‚úÖ ÂêåÊ≠•ÂÆåÊàê', `${currentSource} Êï∞ÊçÆÊó†ÂèòÂåñ`);
                        }

                        lastSyncTime = new Date();
                    },
                    error: function (error) {
                        updateSyncStatus('‚ö† ËøûÊé•ÈîôËØØ', 'CSVËß£ÊûêÈîôËØØ: ' + error.message);
                    }
                });
            } catch (error) {
                updateSyncStatus('‚ö† ËøûÊé•ÈîôËØØ', error.message);
            }
        }

        function createCharts() {
            if (globalData.length === 0) return;

            // ÈîÄÊØÅÁé∞ÊúâÂõæË°®
            Object.values(charts).forEach(chart => chart && chart.destroy());
            charts = {};

            // Â∫îÁî®Êó∂Èó¥Á≠õÈÄâ
            const filteredData = filterDataByTimeRange(globalData);

            if (filteredData.length === 0) {
                showStatus('ÈÄâÊã©ÁöÑÊó∂Èó¥ËåÉÂõ¥ÂÜÖÊ≤°ÊúâÊï∞ÊçÆ', 'error');
                return;
            }

            // Ëé∑ÂèñÊâÄÊúâÊàêÂëò
            const members = [...new Set(filteredData.map(row => row.ÊàêÂëò))];

            // Ëé∑ÂèñÊâÄÊúâÊó∂Èó¥ÁÇπÂπ∂ÊéíÂ∫è
            const timePoints = [...new Set(filteredData.map(row => row.Êõ¥Êñ∞Êó∂Èó¥))].sort((a, b) => parseDateTime(a) -
                parseDateTime(b));

            // ÂàõÂª∫‰∏â‰∏™ÂõæË°®
            const metrics = [{
                    key: 'ËßÇÁúãÊï∞',
                    id: 'viewCountChart',
                    title: 'ËßÇÁúãÊï∞Ë∂ãÂäø'
                },
                {
                    key: 'ÁÇπËµûÊï∞',
                    id: 'likeCountChart',
                    title: 'ÁÇπËµûÊï∞Ë∂ãÂäø'
                },
                {
                    key: 'ËØÑËÆ∫Êï∞',
                    id: 'commentCountChart',
                    title: 'ËØÑËÆ∫Êï∞Ë∂ãÂäø'
                }
            ];

            metrics.forEach(metric => {
                charts[metric.id] = createSplineChart(metric.id, timePoints, metric.key, metric.title, members,
                    filteredData);
            });
        }

        function createSplineChart(containerId, timePoints, dataKey, chartTitle, members, data) {
            // ‰∏∫ÊØè‰∏™ÊàêÂëòÂàõÂª∫Êï∞ÊçÆÁ≥ªÂàó
            const series = members.map(member => {
                const memberData = timePoints.map(time => {
                    const row = data.find(r => r.Êõ¥Êñ∞Êó∂Èó¥ === time && r.ÊàêÂëò === member);
                    if (row) {
                        return [parseDateTime(time).getTime(), parseNumber(row[dataKey])];
                    }
                    return null;
                }).filter(point => point !== null);

                return {
                    name: member,
                    data: memberData,
                    type: 'spline'
                };
            });

            // Ê†πÊçÆÊó∂Èó¥ËåÉÂõ¥Ë∞ÉÊï¥Êó∂Èó¥Ê†ºÂºè
            const getDateFormat = () => {
                if (currentTimeRange === 'all') {
                    return '{value:%m-%d %H:%M}';
                } else {
                    return '{value:%H:%M:%S}';
                }
            };

            charts[containerId] = Highcharts.chart(containerId, {
                chart: {
                    type: 'spline',
                    backgroundColor: '#2d2d2d',
                    height: window.innerWidth < 768 ? 300 : 400
                },
                title: {
                    text: chartTitle,
                    style: {
                        color: '#e0e0e0',
                        fontSize: '16px'
                    }
                },
                xAxis: {
                    type: 'datetime',
                    labels: {
                        format: getDateFormat(),
                        style: {
                            color: '#b0b0b0',
                            fontSize: window.innerWidth < 768 ? '10px' : '12px'
                        },
                        rotation: window.innerWidth < 768 ? -45 : 0
                    },
                    gridLineColor: '#404040',
                    lineColor: '#404040',
                    tickColor: '#404040'
                },
                yAxis: {
                    title: {
                        text: dataKey,
                        style: {
                            color: '#b0b0b0'
                        }
                    },
                    labels: {
                        style: {
                            color: '#b0b0b0',
                            fontSize: window.innerWidth < 768 ? '10px' : '12px'
                        },
                        formatter: function () {
                            return this.value.toLocaleString();
                        }
                    },
                    gridLineColor: '#404040',
                    lineColor: '#404040',
                    tickColor: '#404040'
                },
                tooltip: {
                    backgroundColor: '#2d2d2d',
                    borderColor: '#64B5F6',
                    borderWidth: 1,
                    style: {
                        color: '#e0e0e0'
                    },
                    formatter: function () {
                        const date = new Date(this.x);
                        return `<b>${this.series.name}</b><br/>` +
                            `Êó∂Èó¥: ${date.toLocaleString('zh-CN')}<br/>` +
                            `${dataKey}: ${this.y.toLocaleString()}`;
                    }
                },
                legend: {
                    itemStyle: {
                        color: '#e0e0e0'
                    },
                    itemHoverStyle: {
                        color: '#64B5F6'
                    }
                },
                plotOptions: {
                    spline: {
                        marker: {
                            enabled: true,
                            radius: window.innerWidth < 768 ? 2 : 3
                        },
                        lineWidth: window.innerWidth < 768 ? 2 : 3,
                        states: {
                            hover: {
                                lineWidth: window.innerWidth < 768 ? 3 : 4
                            }
                        }
                    }
                },
                series: series,
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 768
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }
            });

            return charts[containerId];
        }

        // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂ÈáçÊñ∞Ê∏≤ÊüìÂõæË°®
        window.addEventListener('resize', function () {
            Object.values(charts).forEach(chart => {
                if (chart) {
                    chart.reflow();
                }
            });
        });

        // ÂàùÂßãÂåñ - Ëá™Âä®ÂºÄÂßãÂêåÊ≠•
        window.addEventListener('load', () => {
            setTimeout(() => {
                syncFromGoogleSheets();
                // ËÆæÁΩÆËá™Âä®ÂêåÊ≠•ÔºåÊØèÂàÜÈíüÊõ¥Êñ∞‰∏ÄÊ¨°
                autoSyncInterval = setInterval(syncFromGoogleSheets, 60000);
                updateSyncStatus('üü¢ Â∑≤ËøûÊé• - Ëá™Âä®ÂêåÊ≠•‰∏≠');
            }, 1000);
        });

        window.addEventListener('beforeunload', () => autoSyncInterval && clearInterval(autoSyncInterval));
    </script>
</body>

</html>